# CSI 数据处理流程

本文档描述了 `read.py` 脚本的完整执行流程。该脚本用于从 PCAP 文件中读取 CSI（Channel State Information）数据，进行预处理（如子载波裁剪和异常值滤波），并生成可视化图表。流程基于 `__main__` 部分的逻辑，适用于学习和调试。

## 整体概述
- **输入**：PCAP 文件路径（必需），可选的CSI幅度范围（目前没有涉及到相位，只是CSI幅度）和子载波范围参数。
- **输出**：处理后的 CSI 幅度数据、异常值统计，以及 CSI 概览图（热力图 + 单子载波折线图）。
- **依赖**：Numpy、Matplotlib、Scipy 等库。
- **执行方式**：命令行运行，例如 `python read.py capture.pcap 200-350 10-50`。

## 详细步骤

### 1. 命令行参数解析
- 检查命令行参数：至少需要 PCAP 文件路径，否则打印用法并退出。
- 解析可选参数：
  - `amplitude_spec`：幅度范围，如 "200-350"（min-max）、"350"（max）或 "200 350"（min max）。
  - `subcarrier_spec`：子载波范围，如 "10-50"（min-max）、"50"（max）或 "10 50"（min max）。
- 调用 `set_amplitude_range()` 和 `set_subcarrier_range()` 设置全局变量 `AMPLITUDE_MIN/MAX` 和 `SUBCARRIER_MIN/MAX`。

### 2. 读取 PCAP 文件
- 调用 `read_pcap(pcap_path, bandwidth=80)`：
  - 自动检测或固定带宽为 80MHz（适用于 80MHz 场景）。
  - 解析 PCAP 文件，提取样本数据（包括时间戳、RSSI、CSI 等）。
  - 返回 Numpy 结构化数组 `samples`，包含所有样本。
- 打印样本数量。

### 3. 解包 CSI 数据
- 从 `samples['csi']` 提取原始 CSI 数据。
- 调用 `unpack(csi_raw, device='nexus5', fftshift=True)`：
  - 将原始 int16 数据转换为 complex64 复数格式。
  - 应用 FFT 移位（fftshift），调整子载波顺序。
  - 返回解包后的 CSI 矩阵 `csi_unpacked`（形状：n_samples x n_subcarriers）。
- 转换为常规 Numpy 数组 `csi_arr`（类型：complex64）。

### 4. 子载波范围裁剪
- 根据全局 `SUBCARRIER_MIN` 和 `SUBCARRIER_MAX` 裁剪数据：
  - 计算起始索引 `start` 和结束索引 `end`。
  - 对 `csi_arr` 进行列切片：`csi_arr = csi_arr[:, start:end]`。
- 目的：减少数据维度，只保留感兴趣的子载波范围，便于后续处理。

### 5. 计算幅度并应用 Hampel 滤波
- 计算幅度：`csi_amp = np.abs(csi_arr)`（形状：n_samples x n_subcarriers）。
- 调用 `hampel_filter_for_csi(csi_amp)`：
  - 对每个子载波的时间序列应用 Hampel 滤波（滑动窗口中位数 + MAD 检测异常值）。
  - 返回滤波后的幅度 `csi_amp_filtered` 和异常值掩码 `outliers`。
- 打印检测到的异常值总数。
- 目的：去除噪声和异常值，提高数据质量。

### 6. 生成可视化图表
- 调用 `plot_csi_overview(csi_amp_filtered, subcarrier=20, cmap='jet')`：
  - 绘制 CSI 幅度热力图（样本序号 vs 子载波，颜色表示幅度）。
  - 绘制指定子载波（默认 20）的幅度随时间折线图。
  - 应用全局幅度范围裁剪（np.clip），确保显示在 AMPLITUDE_MIN 到 AMPLITUDE_MAX 内。
- 显示图表。

## 关键函数说明
- `read_pcap`：文件 I/O 和数据解析。
- `unpack`：数据格式转换和预处理。
- `hampel_filter_for_csi`：异常值检测和替换。
- `plot_csi_overview`：可视化输出。
- 全局变量：`AMPLITUDE_MIN/MAX`、`SUBCARRIER_MIN/MAX` 用于配置裁剪范围。

## 注意事项
- 数据裁剪（子载波和幅度）在处理早期进行，以优化后续步骤。
- 如果需要调整参数（如带宽、滤波阈值），修改 `__main__` 或函数默认值。
- 异常值滤波基于 Hampel 方法，适合时间序列数据。
- 可视化使用 Matplotlib，支持中文标签（已配置字体）。

此流程可作为学习起点，便于逐步调试和扩展。